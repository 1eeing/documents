## 话单说明

话单为进行通话呼叫时发送的一条消息，标记此次呼叫的状态。
|行为|主叫话单显示|被叫话单显示|
|---|--------|-------|
| 主叫取消话单 | 已取消 | 对方已取消 |
| 被叫拒绝话单 | 对方已拒绝 | 已拒绝 |
| 超时未接听话单 | 未接听 | 未接听 |
| 被叫占线话单 | 对方忙线 | 未接听 |
| 正常通话带有时长的话单 | 已完成+通话时间 | 已完成+通话时间 |

## 话单发送

若用户参考[快速开始](../../../快速开始/跑通示例项目_小程序.md)完成话单功能相关权限开通，则会默认发送话单消息；

话单消息共有5类，其中4类为未接通时的话单，如拒接话单、占线话单、超时未接听话单、主叫取消话单，此类话单均由主叫方客户端发送；1类为带有通话时长的正常话单，此类话单为服务端直接发送。话单结构见话单解析部分。


## 话单接收及解析

### 话单类型及结构体

| 状态值                                    | 话单类型 | 说明                                                         |
| --------------------------------------- | -------- | ------------------------------------------------------------ |
| `complete` | 1        | 正常通话话单，通话双方都进入音视频通话后进行挂断。由组件服务器发送。 |
| `canceled` | 2        | 主叫取消话单，主叫呼叫后主动取消的话单。由客户端主叫方发送。 |
| `rejected` | 3        | 被叫拒接话单，被叫拒接接听后的话单。客户端主叫方收到被叫拒接消息后进行发送。 |
| `timeout`  | 4        | 超时话单，被叫收到通话邀请后不操作等待超时产生的话单。客户端主叫方发送。 |
| `busy`     | 5        | 占线话单（用户忙），当主叫呼叫被叫时，被叫仍处于通话以及呼叫/被叫中，此时被叫会拒绝主叫的通话邀请。客户端主叫收到消息后会发送占线话单。 |

```json
// 收到的话单的json结构
{
   "type": 1,                       //1 表示音频，2 表示视频
   "channelId": 123,                //G2的channelId
   "status": 1,                     //1 表示正常结束通话话单，对应上表的话单类型
   "durations": [
           {
               "accid":"acc01",
               "duration":10
           },
           {
               "accid":"acc02",
               "duration":12
           }
   ]
}
```
话单消息可通过接收组件的`onMessageSent`事件获取，**示例代码** 如下：

```
// statusText是话单展示文案

this.nertcComponent.on('onMessageSent', (data) => {
	console.log("===on message send ,", data)
	const { status, to, type, durations = [] } = data.data
	const isBeCaller = to === this.data.rtcConfig.account
	const statusMap = {
		1: "已完成",
		2: isBeCaller ? "对方已取消" : "已取消",
		3: isBeCaller ? "已拒绝" : '对方已拒绝',
		4: isBeCaller ? "未接听" : '未接听',//对方超时未接听
		5: isBeCaller ? "未接听" : "对方忙线",
	};
	let duration = durations[0] ? durations[0].duration : 0
	let text = status === 1 && duration > 0 ? formatTime(duration) : ''
	this.setData({
		statusText: statusMap[status] + text
	})
})

```


## 实现自己的话单

若组件自带的话单功能不能满足需求，可以参考如下步骤实现自己的话单；

1. 关闭组件自带话单功能；
   1. 进入云信控制后台 - 音视频2.0 - 话单配置 - 关闭；

2. 在云信后台开通对应抄送（此步骤可以获取服务端通话时长）；

   1. 进入云信控制后台 - 消息抄送配置 - 音视频通话2.0相关抄送 - 房间时长消息抄送（eventType=8）

3. 确定话单协议，如用 json 表示

```
// 话单数据格式

const attach = {
	"type": 1, // 话单类型
	"data": ... // 话单消息内容，如通话时长等信息
}

// 发送话单消息userId是当前登录用户，可用来区别主叫被叫的消息展示

this._emitter.emit('onMessageSent', { ...attach, to: userId })
```

4. 组件支持的话单种类如上文共有5类，分别为**主叫取消话单**、**被叫拒绝话单**、**超时未接听话单**、**被叫占线话单**、**正常通话带有时长的话单**。</br>
其中**主叫取消话单**、**被叫拒绝话单**、**超时未接听话单**、**被叫占线话单**都由主叫方统一发送。</br>

可通过`this.NIM.on('signalingNotify')`接收到的事件类型`eventType`来发送不同的话单</br>
* 当`eventType`类型为 `REJECT` 发送被叫拒绝话单
* 当`eventType`类型为 `REJECT`且`event.attachExt === '601'` 发送被叫忙线话单
* 通过判断主叫方呼叫超时时间`callTimeout` 发送超时未接听话单

正常通话带有时长的话单建议由服务端发送，用户服务器收到云信服务器的抄送（房间时长消息抄送（eventType=8））根据抄送发送时长话单。

