[TOC]

# 实现通话呼叫

针对已经集成 IM sdk 的用户若希望快速实现音视频通话功能，可通过集成呼叫组件完成实现。

## 注意事项
1. 若用户已经集成了 IM Sdk 或 NERTc Sdk 需参考**[产品动态](./产品动态-Android.md) **关于 sdk 版本的映射关系，确保使用的 sdk 版本和组件版本一致。
2. 若用户未接入 IM Sdk 可参考[官网](https://doc.yunxin.163.com/docs/TM5MzM5Njk/zU4NzUxNjI?platformId=60002)完成 IM Sdk 的接入。

**用户完成上述两点注意后继续参考下面内容。**


## 准备工作

#### 环境准备

  * 微信 App iOS 最低版本要求：7.0.9。
  * 微信 App Android 最低版本要求：7.0.8。
  * 小程序基础库最低版本要求：2.10.0。
  * 已安装最新版本的微信开发者工具。
  * 已安装微信的移动端设备以供调试和运行体验。
  * 由于微信开发者工具不支持原生组件（即 `<live-pusher>` 和 `<live-player>` 标签），需要在真机上进行运行体验。
  * 由于小程序测试号不具备 `<live-pusher>` 和 `<live-player>` 的使用权限，需要申请常规小程序账号进行开发。
  * 不支持 uniapp 开发环境，请使用原生小程序开发环境。

#### 前提条件

1. 您已网易[云信账号](https://yunxin.163.com/)，并完成实名认证。

2. 出于政策和合规的考虑，微信暂未放开所有小程序对实时音视频功能（即`<live-pusher>` 和 `<live-player>`标签）的支持：
* 小程序推拉流标签不支持个人小程序，只支持企业类小程序。
* 小程序推拉流标签使用权限暂时只开放给有限 类目。
* 符合类目要求的小程序，需要在[【微信公众平台】](https://mp.weixin.qq.com/)>【开发】>【开发管理】>【接口设置】中自助开通该组件权限，如下图所示：

![](https://camo.githubusercontent.com/909e7e42a64031e7a95e7ce7fea32e39e3412a6d05ce1fcf5a0e1b61ae270955/68747470733a2f2f6d61696e2e71636c6f7564696d672e636f6d2f7261772f64633664336339313032626438313434336362323762393831306338653938312e706e67)

#### 开通相关功能

    **注：如果已有相应的应用，可在原应用上申请开通【音视频通话2.0】及【信令】或 【IM 专业版】功能。**

   针对新应用可按照如下操作实现功能开通。

   网易云控制台，点击【应用】>【创建】创建自己的App，在【功能管理】中申请开通如下功能

   1. 若仅使用呼叫功能，则开通

      1. 【信令】
      2. 【音视频通话2.0】
      3. 【安全模式】- 组件支持使用安全模式以及非安全模式，开启安全模式请咨询相应SO。
   2. 若还需使用话单功能，则需要开通
      1. 【IM专业版】
      2. 【G2话单功能】-云信控制台-音视频通话2.0-功能配置-话单配置-开启话单类型消息抄送。

  1. 在控制台中【appkey管理】获取appkey。

## 集成

若需要在项目中引入呼叫组件按照以下步骤执行：

### 0. 前提 

已经完成云信 IM Sdk 接入，并实现了登录功能；

### 1. 复制 nertc-call 到 components 文件

### 2. 添加组件到对应page
```js
// xxx.json
{
  "usingComponents": {
    "nertc-call": "../../components/nertc-call/nertc-call"
  }
}
```

### 3. 使用组件

**wxml文件**

```
<view wx:if="{{!showCallComp && !invited}}" class="container-box">
  <view class='title' style='padding-top:{{(headerHeight + statusBarHeight)/2 - 12}}px'>
    <view>呼叫页</view>
  </view>
  <view class="">
    <text>呼叫人ID：{{rtcConfig.account}}</text>
  </view>

  <view class="input-wrapper">
    <input type="text" data-key="userId" bindinput="changeHandler" placeholder="被呼叫人id" />
  </view>

  <view class='bottom-btn'>
    <button class="btn" bindtap="startCall" hover-class="none">发起呼叫</button>
  </view>
  <view>
    <view>
      <view>通话状态：{{statusText}}</view>
    </view>
  </view>
</view>
<view class="container-box" wx:if="{{invited}}">
  <view class="invite-title">{{inviteData.inviter}}邀请你{{type == 2 ? '视频': '语音'}}通话</view>
  <view class="op-btns">
    <view class="reject" bindtap="onReject">
      <image src="/components/nertc-call/resources/images/hangup.png" />
    </view>
    <view class="accept" bindtap="onAccept">
      <image src="/components/nertc-call/resources/images/hangup.png" />
    </view>
  </view>
</view>

<view class="room-container {{showCallComp ? 'show' : 'hidden'}}">
  <nertc-call id="nertc-component" config="{{rtcConfig}}" />
</view>
```

**js文件**

```js
  Page({
    /**
     * 页面的初始数据
     */
    data: {
      rtcConfig: {
        appkey: '45c6af3c98409b18a84451215d0bdd6e',
        uid: 1,
        imToken: 'e10adc3949ba59abbe56e057f20f883e', //im 登录token
        account: 'luc007',
        nickName: 'luc007',
        passport: '123456',
        openCamera: true,
        openMicrophone: true,
        resolution: 'HD',
        audioQuality: 'high',
        videoWidth: 360,
        videoHeight: 640,
        minBitrate: 600,
        maxBitrate: 900,
        whitenessLevel: 4,
        beautyLevel: 4,
        checkSum: true, //默认安全模式
        debug: false,
      },
      userId: '',
      type: 2, //
      showCallComp: false,
      invited: false
    },
  
  
    /**
     * 生命周期函数--监听页面加载
     */
    onLoad: function (options) {
      this.nertcComponent = this.selectComponent('#nertc-component')
      const queryParams = {
        ...this.data.rtcConfig
      };
      this.setData({
        rtcConfig: queryParams,
        uuid: Math.ceil(Math.random() * 1e5) + ''
      })
      this.bindEvent()
    },
    /**
     * 生命周期函数--监听页面卸载
     */
    onUnload: function () {
      // 取消监听事件
      this.unbindTRTCCallingRoomEvent();
      // 退出登录
      this.TRTCCalling.logout();
    },

    startCall() {
      this.nertcComponent.call({
        userId: this.data.userId,
        type: this.data.type,
        attachment: { call: "testValue" },
        success: (res) => {
          console.log("==call 成功回调", res)
          this.setData({
            showCallComp: true
          })
        },
        fail: (err) => {
          console.log("==call 失败回调", err)
        }
      })
    },

    resetUI() {
      this.setData({
        invited: false,
        showCallComp: false
      })
    },

    changeHandler(e) {
      this.setData({
        userId: e.detail.value
      })
    },

    onAccept() {
      this.nertcComponent.accept({
        ...this.data.inviteData,
        success: (data) => {
          this.setData({ showCallComp: true, invited: false, })
          console.log("接受呼叫:成功回调", data)
        },
        fail: (err) => {
          console.log("接受呼叫:失败回调", err)
          this.resetUI()
        }
      })
    },

    onReject() {
      this.nertcComponent.reject({
        ...this.data.inviteData, success: (data) => {
          console.log("拒绝呼叫:成功回调", data)
        },
        fail: (err) => {
          console.log("拒绝呼叫:失败回调", err)
        }
      })
      this.resetUI()
    },

    bindEvent() {
      const nertcComponentEvent = this.nertcComponent.EVENT
      console.log("this.nertcComponent", this.nertcComponent)
      //收到邀请
      this.nertcComponent.on(nertcComponentEvent.INVITED, (data) => {
        console.log("be invite", data)
        this.setData({
          invited: true,
          inviteData: data.data,
        })
      })
      //自主设置呼叫|被呼的超时时间
      this.nertcComponent.setCallTimeout(30000)
      //被呼叫用户接受  
      this.nertcComponent.on(nertcComponentEvent.USER_ACCEPT, (data) => {
        console.log("user accept", data)
      })
      //被呼叫用户拒绝
      this.nertcComponent.on(nertcComponentEvent.USER_REJECT, (data) => {
        console.log("user reject", data)
        this.resetUI()
      })
      //被呼叫用户超时
      this.nertcComponent.on(nertcComponentEvent.USER_BUSY, () => {
        console.log("user busy")
        this.resetUI()
      })
      //呼叫超时
      this.nertcComponent.on(nertcComponentEvent.CALLING_TIMEOUT, () => {
        console.log("call timeout")
        this.resetUI()
      })
      //取消呼叫
      this.nertcComponent.on(nertcComponentEvent.USER_CANCEL, (data) => {
        console.log("user cancel===", data)
        this.resetUI()
      })
      //通话结束
      this.nertcComponent.on(nertcComponentEvent.CALL_END, () => {
        console.log("====onCallEnd======")
        this.resetUI()
      })
      //disconnect
      this.nertcComponent.on("onDisconnect", () => {
        console.log("====onDisconnect======")
        this.resetUI()
      })
      this.nertcComponent.on(nertcComponentEvent.OTHER_CLIENT_REJECT, () => {
        this.resetUI()
      })
      this.nertcComponent.on(nertcComponentEvent.OTHER_CLIENT_ACCEPT, () => {
        this.resetUI()
      })
      this.nertcComponent.on(nertcComponentEvent.MESSAGE_SENT, (data) => {
        console.log("===on message send ,", data)
        const { status, to } = data.data
        const isBeCaller = to === this.data.rtcConfig.account
        const statusMap = {
          1: "已完成",
          2: isBeCaller ? "对方已取消" : "已取消",
          3: isBeCaller ? "已拒绝" : '对方已拒绝',
          4: isBeCaller ? "未接听" : '未接听',//对方超时未接听
          5: isBeCaller ? "未接听" : "对方忙线",
        };
        this.setData({
          statusText: statusMap[status]
        })
      })
      this.nertcComponent.on(nertcComponentEvent.AUDIO_AVAILABLE, () => {
        //your code
      })
      this.nertcComponent.on(nertcComponentEvent.VIDEO_AVAILABLE, () => {
        //your code
      })
      this.nertcComponent.on(nertcComponentEvent.CALL_TYPE_CHANGE, () => {
        //your code
      })
    }
  })
  
```
### nertc 属性

| 参数 | 类型 | 必填 | 说明 |
|:---:| - | - | - |
| id  | String | 是 | 绑定nertc-call的dom ID，可通过this.selectComponent(ID)获取实例 |
| config | Object | 是 | nertc-call初始化配置 |

### config 参数

| 参数 | 类型 | 必填 | 默认 | 说明 |
|:---:| - | - | - | - |
| appKey | String | 是 | - | 创建网易云信应用的唯一key |
| uid | String | 是 | - | 用户随机数 |
| imToken | String | 是 | - | 呼叫方登录密码加密数据 |
| account | String | 是 | - |  呼叫方账号 |
| nickName | String | 否 | - | 呼叫方昵称 |
| openCamera | Boolean | 否 | - | 是否开启摄像头 |
| openMicrophone |  | 否 | - | 是否开启麦克风 |
| videoWidth | Number | 否 | 360 | 视频画面的宽度 |
| videoHeight | Number | 否 | 640 | 视频画面的高度 |
| minBitrate | Number | 否 | 600 | 最小码率 |
| maxBitrate | Number | 否 | 900 | 最大码率 |
| whitenessLevel | Number | 否 | 0 | 美白等级 |
| beautyLevel | Number | 否 | 0 | 美颜等级 |
| checkSum | Boolean | 否 | true | 是否开启安全模式 |
| debug | Boolean | 否 | false | 是否开启调试模式 |

### 组件方法

**selectComponent()**

您可以通过小程序提供的 this.selectComponent() 方法获取组件实例

```
this.nertcComponent = this.selectComponent('#nertc-component')
```

**login()** 

登入接口，会建议在页面 onLoad 阶段调用。

```
this.selectComponent('#nertc-component').login()
```

**logout()**

登出信令 SDK，执行后不再能收发信令。

```
this.selectComponent('#nertc-component').logout()
```

**on(eventCode, handler, context)**

用于监听组件派发的事件，详细事件请参见 事件表。

```
this.selectComponent('#nertc-component').on(nertcComponentEvent.INVITED, () => {

})
```

**off(eventCode, handler)**

用于取消事件监听。

```
this.selectComponent('#nertc-component').off(nertcComponentEvent.INVITED)
```

**call({userID, type})**

进行某个 user 进行呼叫

|参数|含义|
|--|--|
|userId| 希望呼叫用户的 userId。|
|type| 通话类型，type = 1：语音通话，type =2：视频通话。|

```
this.selectComponent('#nertc-component').call({userID, type})
```


